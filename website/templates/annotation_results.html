{% extends "main.html" %}
{% block content %}
{% include "header.html" %}

<!-- CSS -->
<style>
table {
    width:100%;
}
th, td {
    padding: 5px;
    word-wrap: break-word;
    text-align: left;
    vertical-align:bottom;
}
td.opt1 { 
    text-align: right; 
}
table#t01 th  {
    background-color: white;
    color: black;
}
.checkbox-red[type="checkbox"].filled-in:checked + label:after{
     border: 2px solid #FF5252;
     background-color: #FF5252;
}
.ui-autocomplete-category {
    font-weight: bold;
    padding: .2em .4em;
    margin: .8em 0 .2em;
    line-height: 1.5;
}
.ui-autocomplete .highlight {
    font-weight: bold;
    color: #FF5252;
}
.material-icons {
    color: #1976D2;
}
div.mapped-resource input {
    background-color: orange;
}
</style>

<!-- JavaScript -->
<script>
$(document).ready(function () {
    $("#remove").on("click", function () {
        $('table tr').has('input[name="data-row"]:checked').remove()
    });

    $('select').material_select();

    // As input only interferes with checkboxes and autocompete input fields, Note: some elements have the same id={{key}}
    $('div.mapped-resource input').materialtags({
        maxTags: 1,
        maxChars: 40
    });

    $('#button').click(function(e) { 
        var linkvalue = $("#input").attr( "miriamId" )
        window.open("http://www.ebi.ac.uk/miriam/main/collections/"+linkvalue,"_blank");
    });

});
function viewDatatypeInfo(miriamId) {
    window.open("http://www.ebi.ac.uk/miriam/main/collections/"+miriamId, "_blank")
}
</script>

<!-- Body -->
<div class="container">
    <div class="section">
        <h5>Annotation results for: 
            <a href="{{ ws_input }}" target="_blank">{{ ws_input }}</a>
        </h5>
    </div>
        
    <div class="divider"></div>
    <br><br>


    <div class="mapped-resource" >
        <input type="text" value="Amsterdam,Washington,Sydney,Beijing,Cairo" data-role="materialtags" />
    </div>
</div>

<div class="container">
    <div class="divider"></div>    
    <br><br>

    <div class="section">
        <span>Focus testing!!!</span>
        <br><br>
        
        <table id="t01" class="responsive-table striped bordered">
            <tr>
                <th> Keypath </th>
                <th> Value </th>
                <th> Mapped Resource </th>
                <th> Remove </th>
            </tr>
         	
            {% for key, value in demo_output.iteritems() %}
            <tr>
                <!-- Keypath -->
                <td class="ws_keypath">{{ key }}</td>
                
                <!-- Value for Keypath -->
                <td title="{% if value is string %}{% if re.match(re.compile(all_pattern_dict[value]|string), master_id_dictionary[key][0] ) %}Value matched Regex Pattern:{{ all_pattern_dict[value] }}
                {% else %}Pattern not verfied{% endif %}
                {% else %}No resource identified{% endif %}">{{ master_id_dictionary[key][0] }}
                </td>
                
                <!-- Mapped Resource -->
                <td >
                    {% if value is string %}
                    <i class="small material-icons" onclick="viewDatatypeInfo( '{{value}}' )" title="Click to view Resource" style="float: right">info</i>
                    <div class="mapped-resource" >
                        <input type="text" value="{{ miriam_name_dict[value] }}" miriamId="{{value}}"/>
                    </div>

                    {% else %}
                    <i class="small material-icons" onclick="viewDatatypeInfo('')" title="Click to view Resource" style="float: right">info</i>
                    <div>
                        <label for="search"></label>
                        <input class="search" name="search"  onfocus="getPatternMatchDataForAutocomplete( '{{ key }}' )" placeholder="Select a resource..."></input>
                    </div>

                    <!-- Get Mapped Resource options based on pattern matching to include in autocomplete --> 
                    {{ value }}
                    <!-- <input type="hidden" class="suggested_resources" value="{{ value }}"></input> -->


                    <!-- {% for v in value %}
                        {% for vk, vv in v.iteritems() %}
                            <input type="text" value="http://www.ebi.ac.uk/miriam/main/collections/{{vk}}">{{vv}}</option>
                        {% endfor %}
                    {% endfor %} -->

                    <!-- http://stackoverflow.com/questions/10175445/load-page-on-selection-from-dropdown-form -->
                    <!-- <select onchange="window.open(this.options[this.selectedIndex].value,'_blank')"> 
                        <option value="" disabled selected>Select a resource...</option>
                            {% for v in value %}
                                {% for vk, vv in v.iteritems() %}
                                    <option value="http://www.ebi.ac.uk/miriam/main/collections/{{vk}}">{{vv}}</option>
                                {% endfor %}
                            {% endfor %}
                        <option value="http://www.ebi.ac.uk/miriam/main/collections">No Mapping</option>
                    </select>  -->                          
                    {% endif %}
                </td>

                <!-- Remove row checkbox -->
                 <td class="opt1">
                    <input type="checkbox" class="filled-in checkbox-red" name="data-row" id="{{ key }}"/>
                    <label for="{{ key }}"></label>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <!-- Display FAB -->
    <div class="fixed-action-btn" style="bottom: 30px; right: 30px;">
    <a class="btn-floating btn-large red">
      <i class="large material-icons">mode_edit</i>
    </a>
    <ul>
      <li><button class="btn-floating red accent-2" id="remove" type="button"><i class="material-icons">delete</i></button></li>
      <li><button class="btn-floating green lighten-1" id="convert-table"><i class="material-icons">send</i></button></li>
    </ul>
  </div>
</div>


<script>
// Category autocomplete widget with matching text highlighting
// https://jqueryui.com/autocomplete/#categories
function getPatternMatchDataForAutocomplete(id) {
    console.log(id)

  $.widget( "custom.catcomplete", $.ui.autocomplete, {
    _create: function() {
      this._super();
      this.widget().menu( "option", "items", "> :not(.ui-autocomplete-category)" );
    },
    _renderMenu: function( ul, items ) {
      var that = this,
        currentCategory = "";
      $.each( items, function( index, item ) {
        var li;
        if ( item.category != currentCategory ) {
          ul.append( "<li class='ui-autocomplete-category'>" + item.category + "</li>" );
          currentCategory = item.category;
        }
        li = that._renderItemData( ul, item );
        if ( item.category ) {
          li.attr( "aria-label", item.category + " : " + item.label );
        }
      });
    }
    });

    function highlightText(text, $node) {
                var searchText = $.trim(text).toLowerCase(), currentNode = $node.get(0).firstChild, matchIndex, newTextNode, newSpanNode;
                while ((matchIndex = currentNode.data.toLowerCase().indexOf(searchText)) >= 0) {
                    newTextNode = currentNode.splitText(matchIndex);
                    currentNode = newTextNode.splitText(searchText.length);
                    newSpanNode = document.createElement("span");
                    newSpanNode.className = "highlight";
                    currentNode.parentNode.insertBefore(newSpanNode, currentNode);
                    newSpanNode.appendChild(newTextNode);
                }
            }

    $.ajax({
        url: '{{ url_for("catcomplete") }}',
        contentType: 'application/json',
        method: "POST",
        dataType : 'json',
        data: JSON.stringify({variable:id})
        }).done(function (data) {
            $( ".search" ).catcomplete({
                delay: 0,
                source: data.category_data
        })
        // Moved (.search) to separate method so highlightText works for all dynamincally generated input text fields
        $('.search').each(function() {
            $(this).data('custom-catcomplete')._renderItem = function(ul, item) {
                var $a = $("<a></a>").text(item.label);
                highlightText(this.term, $a);
                return $("<li></li>").append($a).appendTo(ul);
            };
        });
    })
}
</script>


<script>
// Format data as JSON-LD and submit to Firebase
//var Firebase = require("firebase");
var myFirebaseRef = new Firebase("https://smartapi-results.firebaseio.com/results");

var table = $('#t01')
$('#convert-table').click( function () {
    var headerString = "{'@context': 'https://raw.githubusercontent.com/Network-of-BioThings/smartAPI/master/schema/smartAPI.api.jsonld', '@id': 'http://mygene.info/', 'services': [{'outputField':[";
    var endDataString = "]}] }";

    var data = [];
    table.find('tr').each(function (i, el) {
        var $tds = $(this).find('td'),
            keypath = $tds.eq(0).text(),
            value = $.trim($tds.eq(1).text());

            // Account for cells that have a select menu
            if($tds.eq(2).find("select").length > 0) {
                datatype = $.trim($(this).find("select").val());
            }
            else {
                datatype = $.trim($(this).find("a").data("custom-value"));
            }
            // Skip table header row for JSON-LD output
            if (i > 0 ) {
                 dataRow = "{rowId:" + "\'"+(i+1)+"\'" + ", parameterValueType:" + "\'"+ keypath+"\'" + ", value: " + "\'"+value+"\'" + ", datatype: " + "\'"+datatype+"\'"+ "}";
                data.push(dataRow)
            }
    });
    var myJsonData = headerString.concat(data, endDataString)
    var myFormattedJson = JSON.stringify(eval("(" + myJsonData + ")"));
    console.log(myFormattedJson)

    // Submit data to Firebase
    myFirebaseRef.push().set(myJsonData)
});
</script>

{% endblock %}
