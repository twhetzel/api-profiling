{% extends "main.html" %}
{% block content %}
{% include "header.html" %}

<!-- CSS -->
<style>
table {
    width:100%;
}
th, td {
    padding: 5px;
    word-wrap: break-word;
    text-align: left;
    vertical-align:bottom;
}
td.opt1 { 
    text-align: left; 
}
table#t01 th  {
    background-color: white;
    color: black;
}
.checkbox-red[type="checkbox"].filled-in:checked + label:after{
     border: 2px solid #FF5252;
     background-color: #FF5252;
}
.ui-autocomplete-category {
    font-weight: bold;
    padding: .2em .4em;
    margin: .8em 0 .2em;
    line-height: 1.5;
}
.ui-autocomplete .highlight {
    font-weight: bold;
    color: #FF5252;
}
.material-icons {
    color: #1976D2;
}
/*div.mapped-resource input {
    background-color: orange;
}*/


.select2-container {
    vertical-align: bottom;
}

.select2-container--default .select2-selection--multiple{
    height: 40px;
    background-color: white;
    background-color: transparent;
    border: 1px solid #aaa;
    border-radius: 15px;*/
    cursor: text;
    border: none;
}
.select2-container--default.select2-container--focus .select2-selection--multiple {
  /*border: solid black 1px;*/
  border: none;
  outline: 0; }
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #e4e4e4;
    /*border: 1px solid #aaa;*/
    border: none;
    border-radius: 10px; /* was 4 */
    cursor: default;
    float: left;
    margin-right: 5px;
    margin-top: 5px;
    padding: 0 5px;
}
.select2-dropdown {
  background-color: white;
  border: 1px solid #e6e6e6; /*#aaa;*/
  border-radius: 4px;
  box-sizing: border-box;
  display: block;
  position: absolute;
  left: -100000px;
  width: 100%;
  z-index: 1051;
  box-shadow: 5px 5px 5px #d9d9d9; /*added*/
}

</style>

<!-- JavaScript -->
<script>
$(document).ready(function () {
    // Remove tables rows when checkbox is checked
    $("#remove").on("click", function () {
        $('table tr').has('input[name="data-row"]:checked').remove()
    });

    //$('select').material_select();

    $('#button').click(function(e) { 
        var linkvalue = $("#input").attr( "miriamId" )
        window.open("http://www.ebi.ac.uk/miriam/main/collections/"+linkvalue,"_blank");
    });



    // *** TEST *** //
    // var it_works = false;
    // var jsonData;
    // var data;

    // $('.js-example-tokenizer-ajax-data').on('select2:opening', function (evt) {
    //     console.log("Opening Select2 menu...")
    //     var myValue = $(this).attr('id'); //document.getElementById(this.id).getAttribute('id');
    //     console.log("myValue1: ", myValue)
    // });
    //console.log('myGlobalValue:', myGlobalValue)


    //     $.ajax({
    //         url: '{{ url_for("select2ResourceAutocomplete") }}',
    //         dataType: "json",
    //         contentType: 'application/json',
    //         method: "POST",
    //         async: false,
    //         data: JSON.stringify({variable: myValue}),
    //         // work with the response
    //         success: function (response) {
    //             console.log("Ajax response:", response.resource_list); // server response
    //             it_works = true;
    //             jsonData = response.resource_list; // you can use jsonData variable in outside of the function
    //         }
    //     })
    //     console.log("jsonData1:", jsonData)
    //});
    //console.log('myValue:2',myValue)
    //console.log("jsonData2:",jsonData)
    // alert(it_works);

    // function getJSONData (val) {
    //     console.log('Calling getJSONData() method...')
    //     $.ajax({
    //         url: '{{ url_for("testValues") }}',
    //         dataType: "json",
    //         contentType: 'application/json',
    //         method: "POST",
    //         //async: false,
    //         data: JSON.stringify({variable: myValue}),
    //         // work with the response
    //         success: function (response) {
    //             console.log("Ajax1 response:", response.resource_list); // server response
    //             //jsonData = response; // you can use jsonData variable in outside of the function
    //         },
    //         processResults: function(data) {
    //             return {
    //                 results: data.resource_list
    //             };
    //         }
    //     });
    // }

    // var myGeocode = '{{ ws_input }}';
    // console.log("my:",myGeocode)
    // var myData = $.getJSON('{{ url_for("testValues") }}');
    // console.log("DATA:",myData)
    // var keys = Object.keys(myData);
    // console.log('Keys:', keys)
    // var msg = $.ajax({type: "GET", url: '{{ url_for("testValues") }}', async: false}).responseJSON;
    // console.log("MSG:",msg.test_data)

    var myTestValues;
    function getTestValues(callback) {
        var myTestValues = [{ id: 0, text: 'boo' }, { id: 1, text: 'scare' }, { id: 2, text: 'laugh' }];
        callback(myTestValues)
    } 

    $(".js-example-tokenizer-ajax-data").select2({
        placeholder: "Select a resource...",
        maximumSelectionLength: 1
    })

    // $(".js-example-tokenizer-ajax-data").select2({
    //     ajax: {
    //         type: "POST",
    //         url: '{{ url_for("testValues") }}',
    //         //data: JSON.stringify({variable: myValue}),
    //         data: getSelectedElement(function() {
    //             console.log('myValue1: ', myValue)
    //             JSON.stringify({variable: myValue})
    //         }),
    //         async: true,
    //         success: function (responseText) {
    //             console.log("RT:", responseText.test_data)
    //             var values = responseText.test_data
    //             $(".js-example-tokenizer-ajax-data").select2({
    //                 data: responseText.test_data,
    //                 tags: true
    //             });
    //         },
    //         error: function () {
    //            // Do something when it fails here
    //            console.log("Error with Ajax")
    //         }
    //     }
    // });



    // $.ajax({
    //     type: "POST",
    //     url: '{{ url_for("testValues") }}',
    //     data: JSON.stringify({variable: this.context.id}),
    //     // data: getSelectedElement(function() {
    //     //     console.log('myValue1: ', myValue)
    //     //     JSON.stringify({variable: myValue})
    //     // }),
    //     async: true,
    //     success: function (responseText) {
    //         console.log("RT:", responseText.test_data)
    //         var values = responseText.test_data
    //         $(".js-example-tokenizer-ajax-data").select2({
    //             data: responseText.test_data,
    //             tags: true
    //         });
    //     },
    //     error: function () {
    //        // Do something when it fails here
    //        console.log("Error with Ajax")
    //     }
    // });

    var myValue;
    // function getSelectedElement(callback) {
        $('.js-example-tokenizer-ajax-data').on('select2-focus', function (evt) {
            console.log("Opening Select2 menu...")
            myValue = $(this).attr('id');
            console.log("myValue: ", myValue)
            // callback(myValue);

            $.ajax ({
            type: "POST",
            url: '{{ url_for("testValues") }}',
            data: JSON.stringify({variable: myValue}),
            // data: getSelectedElement(function() {
            //     console.log('myValue1: ', myValue)
            //     JSON.stringify({variable: myValue})
            // }),
            async: true,
            success: function (responseText) {
                console.log("RT:", responseText.test_data)
                var values = responseText.test_data
                $(".js-example-tokenizer-ajax-data").select2({
                    data: responseText.test_data,
                    tags: true
                });
            },
            error: function () {
               // Do something when it fails here
               console.log("Error with Ajax")
            }
        })
        });
    // }





    // $('.select2').select2({}).focus(function () { $(this).select2('open'); });
    // $(".js-example-tokenizer-ajax-data").on("select2:open", function(e) { 
    //     console.log("Open:", $(this).attr('id'));
    //     // alert($(this).attr('id'));
    // });


    // var jsonData;
    // getSelectedElement(function() {
    //     console.log('myValue1: ', myValue)
        // var selectedEle = $('.js-example-tokenizer-ajax-data').attr('id');
        // console.log("SE:", selectedEle)
        //var selectedEle = $(document.activeElement); //.getElementById(this.id).getAttribute('id')
        //$('.js-example-tokenizer-ajax-data').is(':focus');
        //console.log("SE:", selectedEle)
        // var se = document.activeElement.getElementsByTagName("select")[0].getAttribute("id");
        // var se = document.getElementsByClassName("select2-selection__rendered")
        // console.log('se:', se)
        //console.log($(".js-example-tokenizer-ajax-data").select2().find("select2:open"))
        // alert($("*:focus").attr("id"));
        

        // $.ajax ({
        //     url: '{{ url_for("testValues") }}',
        //     dataType: "json",
        //     contentType: 'application/json',
        //     method: 'POST',
        //     dataType: 'json',
        //     async: false,
        //     // data: JSON.stringify({variable: myValue}),
        //     success: function (responseText) {
        //         console.log("RT:", responseText.test_data)
        //         var values = responseText.test_data
        //         $(".js-example-tokenizer-ajax-data").select2({
        //             data: values.test_data,
        //             tags: true
        //         });
        //     },
        //     error: function () {
        //        // Do something when it fails here
        //        console.log("Error with Ajax")
        //     }
        // })
        // console.log('myValue2:', myValue)
        // console.log('jsonData2:', jsonData)  
        // populateSelect()
    // });


    // function populateSelect() {
    //     console.log('jsonData3:', jsonData)
    // }
    // console.log('AC:', acValues)

    // var data = [{ id: 0, text: 'enhancement' }, { id: 1, text: 'bug' }, { id: 2, text: 'duplicate' }, { id: 3, text: 'invalid' }, { id: 4, text: 'wontfix' }];
    // $(".js-example-tokenizer-ajax-data").select2({
    //     data: data,
    //     tags: true,
    //     maximumSelectionLength: 3
    // });


    // $(".js-example-tokenizer-ajax-data").select2({
    //     data: jsonData,
    //     tags: true,
    //     maximumSelectionLength: 3
    // })

    
    // var jsonData;
    // myValue = 'Test Value'

    // $.ajax ({
    //     url: '{{ url_for("select2ResourceAutocomplete") }}',
    //     dataType: "json",
    //     contentType: 'application/json',
    //     method: 'POST',
    //     dataType: 'json',
    //     async: false,
    //     data: JSON.stringify({variable: myValue}),
    //     // data: getSelectedElement(function() {
    //     //     alert('Finished eating my sandwich.'); 
    //     //     console.log('myValue1: ', myValue)
    //     //     return JSON.stringify({variable: myValue}) 
    //     // }),
    //     success: function(data) {
    //         console.log('jsonData1:', data.resource_list)
    //         it_works = true;
    //         jsonData = data.resource_list;
    //     }
    // });
    // console.log("jsonData2:",jsonData)
    // alert(it_works);

    // $(".js-example-tokenizer-ajax-data").select2({
    // })

    // $(".js-example-tokenizer-ajax-data").select2({
    //     data: jsonData,
    //     tags: true,
    //     maximumSelectionLength: 3
    // })


    // var data = [{ id: 0, text: 'enhancement' }, { id: 1, text: 'bug' }, { id: 2, text: 'duplicate' }, { id: 3, text: 'invalid' }, { id: 4, text: 'wontfix' }];

    // var myValue = 'some test value'
    // console.log("myValue:",myValue)
    
    // var myData = $.post('{{ url_for("select2ResourceAutocomplete",variable='myValue') }}', function(data) {
    // });
    // console.log("myData:", myData.resource_list)
    

    // var data = [{text: 'Pattern Match', children: [{id: 'value one', text: 'Text one to display'}, {id: 'value two',text: 'Text two to display'}]}, {text: 'All Resources', children: [{id: 'resource one',text: 'Resource one to display'}, {id: 'resource two', text: 'Resource two to display'}]}]
    // *** END TEST *** //



    // ** This works to return data but no autocomplete **
    // Match at start of each token 
    // https://select2.github.io/examples.html#matcher
    // function matchStart (term, text) {
    //  if (text.toUpperCase().indexOf(term.toUpperCase()) == 0) {
    //      return true;
    //  }
    //  return false;
    // }

    // NOTE: Custom matcher matches within words, but free text input is no longer available?
    // $.fn.select2.amd.require(['select2/compat/matcher'], function (oldMatcher) {
        // $(".js-example-tokenizer-ajax-data").select2({
        //     //matcher: oldMatcher(matchStart),
        //     tags: true, //Allows for free text input of tag values
        //     createTag: function (params) {
        //         return {
        //           id: params.term,
        //           text: params.term,
        //           newOption: true
        //         }
        //     },
        //     templateResult: function (data) {
        //         var $result = $("<span></span>");
        //         $result.text(data.text);
        //         if (data.newOption) {
        //             $result.append(" <em>(new)</em>");
        //         }
        //         return $result;
        //     },
        //     placeholder: 'Select a resource or enter your own',
        //     maximumSelectionLength: 1,
        //     ajax: {
        //         url: '{{ url_for("select2ResourceAutocomplete") }}',
        //         delay: 250,
        //         contentType: 'application/json',
        //         method: "POST",
        //         dataType : 'json',
        //         data: function() {
        //             var myValue = $(this).attr('id');
        //             console.log(JSON.stringify({variable: myValue}))
        //             return JSON.stringify({variable: myValue})
        //         },
        //         processResults: function (data) {
        //             //console.log(data.resource_list)
        //             // Map data attributes as needed to 'id' and 'text' as required by Select2
        //       //    data = $.map(data.resource_list, function (obj) {
        //       //        obj.text = obj.text || obj.label; // replace name with the property used for the text
        //       //        return obj;
        //             // });
        //             return {
        //                 results: data.resource_list
        //             };
        //         }
        //     }
        // });
    // }); //End for oldMatcher
});

// Populate link with MIRIAMID
function viewDatatypeInfo(miriamId) {
    window.open("http://www.ebi.ac.uk/miriam/main/collections/"+miriamId, "_blank")
}
</script>

<!-- Body -->
<main>
    <section>
        <div class="container">
            <div class="section">
                <h5>Annotation results for: 
                    <a href="{{ ws_input }}" target="_blank">{{ ws_input }}</a>
                </h5>
            </div>
            <div class="divider">
            </div>    
            <br><br>
        </div>
    </section>

<section>
<div class="container">
    <div class="section">
        <table id="t01" class="responsive-table bordered">
            <tr>
                <th> Remove </th>
                <th> Keypath </th>
                <th> Value </th>
                <th> Mapped Resource </th>
            </tr>
         	
            {% for key, value in demo_output.iteritems() %}
            <tr>
                <!-- Remove row checkbox -->
                 <td class="opt1" style="width:10%">
                    <input type="checkbox" class="filled-in checkbox-red" name="data-row" id="{{ key }}"/>
                    <label for="{{ key }}"></label>
                </td>

                <!-- Keypath -->
                <td class="ws_keypath" style="width:20%">{{ key }}</td>
                
                <!-- Value for Keypath -->
                <td style="width:20%"><a class="tooltipped" data-position="top" data-delay="50" data-tooltip="{% if value is string %}{% if re.match(re.compile(all_pattern_dict[value]|string), master_id_dictionary[key][0] ) %}Value matched Regex Pattern:{{ all_pattern_dict[value] }}
                {% else %}Pattern not verfied{% endif %}
                {% else %}No resource identified{% endif %}">{{ master_id_dictionary[key][0] }}
                <a/></td>
                
                <!-- Mapped Resource -->
                <td style="width:50%">
                    {% if value is string %}
                    <i class="small material-icons" onclick="viewDatatypeInfo( '{{value}}' )" title="Click to view Resource" style="float: right">info</i>
                    <!-- <select id="{{ key }}" class="js-example-tokenizer-ajax-data" multiple="multiple" miriamId="{{ value }}" style="width:90%">
                        <option value="{{ key }}" selected>{{ miriam_name_dict[value] }}</option>
                    </select> --> 

                    <select id="{{ key }}" class="js-example-tokenizer-ajax-data search" multiple="multiple" name="search" style="width:90%">
                        <optgroup label="All Resources">
                            {% for res_id, res_name in miriam_name_dict.iteritems() %}
                            <option value='{{res_id}}'>{{ res_name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>

<!--                     <div class="mapped-resource">
                        <input type="text" value="{{ miriam_name_dict[value] }}" miriamId="{{value}}"/>
                    </div>
 -->
                    {% else %}
                    <i class="small material-icons" onclick="viewDatatypeInfo('')" title="Click to view Resource" style="float: right">info</i>
                    <!-- <select id="{{ key }}" class="js-example-tokenizer-ajax-data search" multiple="multiple" name="search" onfocus="getPatternMatchDataForAutocomplete( '{{ key }}' )" style="width:90%">
                    </select> -->

                    <select id="{{ key }}" class="js-example-tokenizer-ajax-data search" multiple="multiple" name="search" style="width:90%">
                        <optgroup label="Pattern Matches">
                        {% for val in value %}
                        {% for key, value in val.iteritems() %}
                            <option value="{{ key }}">{{ value }}</option>
                        {% endfor %}
                        {% endfor %}
                        </optgroup>
                        <optgroup label="All Resources">
                            {% for res_id, res_name in miriam_name_dict.iteritems() %}
                            <option value='{{res_id}}'>{{ res_name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>

                   <!--  <div>
                        <label for="search"></label>
                        <input type="text" class="search" name="search"  onfocus="getPatternMatchDataForAutocomplete( '{{ key }}' )" placeholder="Select a resource..."></input>
                    </div> -->

                    <!-- Get Mapped Resource options based on pattern matching to include in autocomplete --> 
                    {{ value }}
                    <!-- <input type="hidden" class="suggested_resources" value="{{ value }}"></input> -->


                    <!-- {% for v in value %}
                        {% for vk, vv in v.iteritems() %}
                            <input type="text" value="http://www.ebi.ac.uk/miriam/main/collections/{{vk}}">{{vv}}</option>
                        {% endfor %}
                    {% endfor %} -->

                    <!-- http://stackoverflow.com/questions/10175445/load-page-on-selection-from-dropdown-form -->
                    <!-- <select onchange="window.open(this.options[this.selectedIndex].value,'_blank')"> 
                        <option value="" disabled selected>Select a resource...</option>
                            {% for v in value %}
                                {% for vk, vv in v.iteritems() %}
                                    <option value="http://www.ebi.ac.uk/miriam/main/collections/{{vk}}">{{vv}}</option>
                                {% endfor %}
                            {% endfor %}
                        <option value="http://www.ebi.ac.uk/miriam/main/collections">No Mapping</option>
                    </select>  -->                          
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <!-- Display FAB -->
    <div class="fixed-action-btn" style="bottom: 30px; right: 30px;">
    <a class="btn-floating btn-large red">
      <i class="large material-icons">mode_edit</i>
    </a>
    <ul>
      <li><button class="btn-floating red accent-2" id="remove" type="button"><i class="material-icons">delete</i></button></li>
      <li><button class="btn-floating green lighten-1" id="convert-table"><i class="material-icons">send</i></button></li>
    </ul>
  </div>
</div>
</section>
</main>

<script>
// Category autocomplete widget with matching text highlighting
// https://jqueryui.com/autocomplete/#categories
function getPatternMatchDataForAutocomplete(id) {
    console.log(id)

  $.widget( "custom.catcomplete", $.ui.autocomplete, {
    _create: function() {
      this._super();
      this.widget().menu( "option", "items", "> :not(.ui-autocomplete-category)" );
    },
    _renderMenu: function( ul, items ) {
      var that = this,
        currentCategory = "";
      $.each( items, function( index, item ) {
        var li;
        if ( item.category != currentCategory ) {
          ul.append( "<li class='dropdown-button btn' href='#' data-activates='dropdown1'>" + item.category + "</li><li class=\"divider\"></li>" );
          currentCategory = item.category;
        }
        li = that._renderItemData( ul, item );
        if ( item.category ) {
          li.attr( "aria-label", item.category + " : " + item.label );
        }
      });
    }
    });

    function highlightText(text, $node) {
                var searchText = $.trim(text).toLowerCase(), currentNode = $node.get(0).firstChild, matchIndex, newTextNode, newSpanNode;
                while ((matchIndex = currentNode.data.toLowerCase().indexOf(searchText)) >= 0) {
                    newTextNode = currentNode.splitText(matchIndex);
                    currentNode = newTextNode.splitText(searchText.length);
                    newSpanNode = document.createElement("span");
                    newSpanNode.className = "highlight";
                    currentNode.parentNode.insertBefore(newSpanNode, currentNode);
                    newSpanNode.appendChild(newTextNode);
                }
            }

    $.ajax({
        url: '{{ url_for("catcomplete") }}',
        contentType: 'application/json',
        method: "POST",
        dataType : 'json',
        data: JSON.stringify({variable:id})
        }).done(function (data) {
            $( ".search" ).catcomplete({
                delay: 0,
                source: data.category_data
        })

        // Add style for drop-down items
        //$("ul").addClass('dropdown-content')

        // Moved (.search) to separate method so highlightText works for all dynamincally generated input text fields
        $('.search').each(function() {
            $(this).data('custom-catcomplete')._renderItem = function(ul, item) {
                var $a = $("<a></a>").text(item.label);
                highlightText(this.term, $a);
                return $("<li></li>").append($a).appendTo(ul);
            };
        });
    })
}
</script>


<script>
// Format data as JSON-LD and submit to Firebase
//var Firebase = require("firebase");
var myFirebaseRef = new Firebase("https://smartapi-results.firebaseio.com/results");

var table = $('#t01')
$('#convert-table').click( function () {
    var headerString = "{'@context': 'https://raw.githubusercontent.com/Network-of-BioThings/smartAPI/master/schema/smartAPI.api.jsonld', '@id': 'http://mygene.info/', 'services': [{'outputField':[";
    var endDataString = "]}] }";

    var data = [];
    table.find('tr').each(function (i, el) {
        var $tds = $(this).find('td'),
            keypath = $tds.eq(1).text(),
            value = $.trim($tds.eq(2).text());

            // Account for cells that have a select menu
            if($tds.eq(3).find("select").length > 0) {
                datatype = $.trim($(this).find("select").val());
            }
            else {
                datatype = $.trim($(this).find("a").data("custom-value"));
            }
            // Skip table header row for JSON-LD output
            if (i > 0 ) {
                 dataRow = "{rowId:" + "\'"+(i+1)+"\'" + ", parameterValueType:" + "\'"+ keypath+"\'" + ", value: " + "\'"+value+"\'" + ", datatype: " + "\'"+datatype+"\'"+ "}";
                data.push(dataRow)
            }
    });
    var myJsonData = headerString.concat(data, endDataString)
    var myFormattedJson = JSON.stringify(eval("(" + myJsonData + ")"));
    console.log(myFormattedJson)

    // Submit data to Firebase
    myFirebaseRef.push().set(myJsonData)
});
</script>

{% endblock %}
