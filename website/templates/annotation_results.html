{% extends "main.html" %}
{% block content %}
{% include "header.html" %}

<style>
table {
    width:100%;
}
th, td {
    padding: 5px;
    word-wrap: break-word;
    text-align: left;
    vertical-align:bottom;
}
td.opt1 { 
    text-align: left; 
}
table#t01 th  {
    background-color: white;
    color: black;
}
.checkbox-red[type="checkbox"].filled-in:checked + label:after{
     border: 2px solid #FF5252;
     background-color: #FF5252;
}
.material-icons {
    color: #1976D2;
}
.select2-container {
    vertical-align: bottom;
}
.select2-container--default .select2-selection--multiple{
    height: 20px;
    background-color: white;
    border: 1px solid #aaa;
    border-radius: 4px;
    cursor: text;
    border: none;
    padding-top: 0px;
}
.select2-container--default.select2-container--focus .select2-selection--multiple {
    border: none;
    outline: 0; 
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #e4e4e4;
    border: none;
    border-radius: 10px;
    cursor: default;
    float: left;
    margin-right: 5px;
    margin-top: 5px;
    padding: 0 5px;
}
.select2-dropdown {
  background-color: white;
  border: 1px solid #e6e6e6;
  border-radius: 4px;
  box-sizing: border-box;
  display: block;
  position: absolute;
  left: -100000px;
  width: 100%;
  z-index: 1051;
  box-shadow: 5px 5px 5px #d9d9d9;
}
</style>


<script>
$(document).ready(function () {
    // Remove tables rows when checkbox is checked
    $("#remove").on("click", function () {
        $('table tr').has('input[name="data-row"]:checked').remove()
    });

    // Link out to MIRIAM for selected resource
    $('#button').click(function(e) { 
        var linkvalue = $("#input").attr( "miriamId" )
        window.open("http://www.ebi.ac.uk/miriam/main/collections/"+linkvalue,"_blank");
    });

    // Initialize Select2
    $(".js-example-tokenizer-ajax-data").select2({
        placeholder: "Select a resource...",
        maximumSelectionLength: 1,
        tags: true
    })
});

// Get Miriam ID of selected resource annotation option based on Info element
$(document).on('click','i',function(e){
    var infoElement_KeypathId = $(this).attr('id')  
    var siblingSelectElement = $(this).siblings( "select")
    
    var mySelectedElementValue = siblingSelectElement.find(":selected").text();
    var mySelectedElementId = siblingSelectElement.find(":selected").val();

    var miriamPrefix = "MIR";
    
    // Check if siblingSelectElement not null or None
    if (mySelectedElementId && mySelectedElementId.startsWith(miriamPrefix)) {
        window.open("http://www.ebi.ac.uk/miriam/main/collections/"+mySelectedElementId, "_blank")
    }
    else if (mySelectedElementId && mySelectedElementValue != "None") {
        alert("Can only view resource information for entries in Identifiers.org.")
    }
    else {
        alert("Please select a resource first.")
    }
})
</script>


<main>
    <section>
    <div class="container">
        <div class="section">
            <h5>Annotation results for: 
                <a href="{{ ws_input }}" target="_blank">{{ ws_input }}</a>
            </h5>
        </div>
        <div class="divider">
        </div>    
        <br><br>
    </div>
    </section>

    <section>
    <div class="container">
    <div class="section">
        <table id="t01" class="responsive-table bordered">
            <tr>
                <th> Remove </th>
                <th> Keypath </th>
                <th> Value </th>
                <th> Mapped Resource </th>
            </tr>
         	
            {% for key, value in demo_output.iteritems() %}
            <tr>
                <!-- Remove row checkbox -->
                 <td class="opt1" style="width:10%">
                    <input type="checkbox" class="filled-in checkbox-red" name="data-row" id="{{ key }}"/>
                    <label for="{{ key }}"></label>
                </td>

                <!-- Keypath -->
                <td class="ws_keypath" style="width:20%">{{ key }}</td>
                
                <!-- Value for Keypath -->
                <td style="width:20%"><a class="tooltipped" data-position="top" data-delay="50" data-tooltip="{% if value is string %}{% if re.match(re.compile(all_pattern_dict[value]|string), master_id_dictionary[key][0] ) %}Value matched Regex Pattern:{{ all_pattern_dict[value] }}
                {% else %}Pattern not verfied{% endif %}
                {% else %}No resource identified{% endif %}">{{ master_id_dictionary[key][0] }}
                <a/></td>
                
                <!-- Mapped Resource -->
                <td style="width:50%">
                    {% if value is string %}
                    <i class="small material-icons" id="{{ key }}" title="Click to view Resource" style="float: right">info</i>
                   
                   <!-- Select menu when no pattern matches -->
                    <select id="{{ key }}" class="js-example-tokenizer-ajax-data search" multiple="multiple" name="search" style="width:90%">
                        <optgroup label="All Resources">
                            {% for res_id, res_name in miriam_name_dict.iteritems() %}
                            {% if res_id|string() == value|string() %}
                            <option value="{{ res_id }}" selected="">{{ res_name }}</option> 
                            {% else %}
                            <option value='{{res_id}}'>{{ res_name }}</option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>

                    {% else %}

                    <i class="small material-icons" id="{{ key }}" title="Click to view Resource" style="float: right">info</i>
                    
                    <!-- Select menu for pattern matches and all resources -->
                    <select id="{{ key }}" class="js-example-tokenizer-ajax-data search" multiple="multiple" name="search" style="width:90%">
                        <optgroup label="Pattern Matches">
                        {% for pattern_res_id, pattern_res_name in value.iteritems() %}
                            <option value="{{ pattern_res_id }}">{{ pattern_res_name }}</option>
                        {% endfor %}
                        </optgroup>
                        <optgroup label="All Resources">
                            {% for res_id, res_name in miriam_name_dict.iteritems() %}
                            <option value='{{res_id}}'>{{ res_name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                         
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <!-- Display FAB Only -->
    <div class="fixed-action-btn" style="bottom: 45px; right: 70px;">
        <button class="btn-floating btn-large green lighten-1" id="convert-table">
            <i class="material-icons">send</i>
        </button>
    </div>

    <!-- Display FAB - Extra buttons on Hover -->
    <!-- <div class="fixed-action-btn" style="bottom: 30px; right: 30px;">
    <a class="btn-floating btn-large red">
      <i class="large material-icons">mode_edit</i>
    </a>
    <ul>
      <li><button class="btn-floating red accent-2" id="remove" type="button"><i class="material-icons">delete</i></button></li>
      <li><button class="btn-floating green lighten-1" id="convert-table"><i class="material-icons">send</i></button></li>
    </ul>
  </div> -->
</div>
</section>
</main>


<script>
// Format data as JSON-LD and submit to Firebase
//var Firebase = require("firebase");
var myFirebaseRef = new Firebase("https://smartapi-results.firebaseio.com/results");

var table = $('#t01')
$('#convert-table').click( function () {
    // var headerString = "{'@context': 'https://raw.githubusercontent.com/Network-of-BioThings/smartAPI/master/schema/smartAPI.api.jsonld', '@id': 'http://mygene.info/', 'services': [{'outputField':[";
    // var endDataString = "]}] }";

    var headerString = "{'root':{'@context':{'my_id_list': 'http://identifiers.org'}},";
    var endDataString = "}";
    // console.log(headerString);
    // console.log(endDataString);

    var contxt_abbr = [];
    var data = [];
    table.find('tr').each(function (i, el) {
        var $tds = $(this).find('td'),
            keypath = $tds.eq(1).text(),
            value = $.trim($tds.eq(2).text());

            // Account for cells that have a select menu
            if($tds.eq(3).find("select").length > 0) {
                datatype = $.trim($(this).find("select").val()); // E.g. returns MIR:00000015
                resource_name = $.trim($(this).find("option:selected").text()); // E.g. returns NCBI Gene
                resource_name = resource_name.toLowerCase().replace(/ /g,"_");  // E.g. ncbi_gene
                resource_url = "http://www.ebi.ac.uk/miriam/main/collections/"+datatype; 
            }
            else {
                datatype = $.trim($(this).find("a").data("custom-value"));
            }
            // Skip table header row for JSON-LD output
            if (i > 0 ) {
                // dataRow = "{rowId:" + "\'"+(i+1)+"\'" + ", parameterValueType:" + "\'"+ keypath+"\'" + ", value: " + "\'"+value+"\'" + ", datatype: " + "\'"+datatype+"\'"+ "}";
                
                // Below works!
                // dataRow = "'rowId" + (i+1)+"\'" + ": {'@context': { 'parameterValueType':" + "\'"+ keypath+"\'" + ", 'value': " + "\'"+value+"\'" + ", 'datatype': " + "\'"+datatype+"\'"+ "}}";

                // TEST
                // console.log(resource_name)

                dataRow = "\'"+keypath+"\'" + ": {'@context': {" + "\'"+ resource_name+"\':" + "\'"+ resource_url+"\'" +"}}";

                // console.log(dataRow)
                data.push(dataRow)
            }
    });
    var myJsonData = headerString.concat(data, endDataString)
    var myFormattedJson = JSON.stringify(eval("(" + myJsonData + ")"));
    console.log(myFormattedJson)

    // Submit data to Firebase
    myFirebaseRef.push().set(myJsonData)
});
</script>

{% endblock %}
